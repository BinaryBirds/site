<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="canonical" href="http://localhost:3000/blog/posts/beginners-guide-to-swift-macros/">
    
    <link rel="next" href="[&quot;description&quot;: &quot;In this tutorial I\&#39;ll show you how to build OpenAPI 3.0+ specifications efficiently using Swift &amp; OpenAPIKit.&quot;, &quot;imageUrl&quot;: false, &quot;hreflang&quot;: [], &quot;noindex&quot;: false, &quot;slug&quot;: &quot;blog/posts/how-to-write-openapi-specs-using-swift-and-openapi-kit&quot;, &quot;canonical&quot;: &quot;http://localhost:3000/blog/posts/how-to-write-openapi-specs-using-swift-and-openapi-kit/&quot;, &quot;js&quot;: [], &quot;publication&quot;: ToucanSDK.PageBundle.Context.DateValue(html: &quot;2023.07.06. 16:15&quot;, rss: &quot;Thu, 06 Jul 2023 16:15:54 +0000&quot;, sitemap: &quot;2023-07-06&quot;), &quot;css&quot;: [], &quot;lastModification&quot;: ToucanSDK.PageBundle.Context.DateValue(html: &quot;2024.08.09. 07:24&quot;, rss: &quot;Fri, 09 Aug 2024 07:24:23 +0000&quot;, sitemap: &quot;2024-08-09&quot;), &quot;expiration&quot;: false, &quot;title&quot;: &quot;How to write OpenAPI specs using Swift and OpenAPIKit?&quot;, &quot;permalink&quot;: &quot;http://localhost:3000/blog/posts/how-to-write-openapi-specs-using-swift-and-openapi-kit/&quot;]">
    
    <title>Beginner&#39;s guide to Swift macros - Binary Birds</title>
    <meta name="description" content="Learn how to create and publish your very first macro using SPM and the brand new Macro APIs introduced in Swift 5.9.">
    
    <meta property="og:url" content="http://localhost:3000/blog/posts/beginners-guide-to-swift-macros/">
    <meta property="og:title" content="Beginner&#39;s guide to Swift macros - Binary Birds">
    <meta property="og:description" content="Learn how to create and publish your very first macro using SPM and the brand new Macro APIs introduced in Swift 5.9.">
    

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Beginner&#39;s guide to Swift macros - Binary Birds">
    <meta name="twitter:description" content="Learn how to create and publish your very first macro using SPM and the brand new Macro APIs introduced in Swift 5.9.">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap">

    <link rel="stylesheet" href="http://localhost:3000/css/modern-normalize.css">
    <link rel="stylesheet" href="http://localhost:3000/css/modern-base.css">
    <link rel="stylesheet" href="http://localhost:3000/css/variables.css">
    <link rel="stylesheet" href="http://localhost:3000/css/base.css">
    <link rel="stylesheet" href="http://localhost:3000/css/grid.css">
    <link rel="stylesheet" href="http://localhost:3000/css/navigation.css">
    <link rel="stylesheet" href="http://localhost:3000/css/footer.css">
    <link rel="stylesheet" href="http://localhost:3000/css/style.css">

    
    
    <link rel="icon" href="http://localhost:3000/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="http://localhost:3000/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="http://localhost:3000/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="http://localhost:3000/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:3000/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="http://localhost:3000/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:3000/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="http://localhost:3000/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:3000/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="http://localhost:3000/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:3000/icons/apple-touch-icon-180x180.png">

    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
        media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
        media="(prefers-color-scheme: dark)"
    >

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

</head>

<body>

    <div id="navigation-container">
        <header id="navigation" class="wrapper">
            <a href="/">
                <picture>
                    <source
                        srcset="http://localhost:3000/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                        >
                    <img
                        src="http://localhost:3000/images/logos/logo.png"
                        alt="Logo of Binary Birds"
                        title="Binary Birds"
                        >
                </picture>
            </a>
            <nav>
                <input type="checkbox" id="primary-menu-button" name="menu-button" class="menu-button">
                    <label for="primary-menu-button">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </label>
                    <div class="menu-items">
                        <a href="/development/">Development</a>
                        <a href="/consulting/">Consulting</a>
                        <a href="/blog/">Blog</a>
                        <a href="/contact/">Contact</a>
                    </div>
            </nav>
        </header>
    </div>
    
    <main>
        <div class="wrapper">
        <div class="article-with-toc">
            <div>
                <article>
                    <header>
        
                        <div class="meta">
                            <time datetime="2023.06.07. 14:57">2023.06.07. 14:57</time>
                             &middot; <span class="reading-time">3 min read</span>
                        </div>
                        
                        <h1>Beginner&#39;s guide to Swift macros</h1>
                        <p>Learn how to create and publish your very first macro using SPM and the brand new Macro APIs introduced in Swift 5.9.</p>
                    </header>
        
                    <section>
                        <h2 id="getting-started">Getting started</h2><p>First of all, you‚Äôll need to install Swift 5.9 to take advantage of the new macro system. You can download Xcode 15 (currently in beta) from Apple‚Äôs <a href="https://developer.apple.com/develop/" target="_blank">developer protal</a> or you can get the latest snapshot version of the Swift toolchain from <a href="https://www.swift.org/download/#snapshots" target="_blank">swift.org</a>.</p><p>In order to create and use a macro you have to create a new Swift package, using the <a href="https://www.swift.org/package-manager/" target="_blank">package manager</a>. I‚Äôm going to do this without Xcode, I‚Äôll place a <code>Package.swift</code> file into a new <code>macro-examples</code> folder.</p><p>To speed up the project creation process, just run the following command using the Terminal application. ü§ì</p><pre><code class="language-sh">mkdir -p macro-examples && cd $_
mkdir -p Sources
mkdir -p Sources/Examples
mkdir -p Sources/MyMacros
mkdir -p Sources/MyMacrosPlugin
mkdir -p Sources/MyMacrosPlugin/Macros
mkdir -p Tests
mkdir -p Tests/MyMacrosTests
touch Package.swift
touch Sources/Examples/main.swift
touch Sources/MyMacros/MyMacros.swift
touch Sources/MyMacrosPlugin/MyMacrosPlugin.swift
touch Sources/MyMacrosPlugin/Macros/InitMacro.swift
touch Tests/MyMacrosTests/MyMacrosTests.swift
</code></pre><p>Update the contents of the <code>Package.swift</code> file. We‚Äôre going to add the brand new <code>CompilerPluginSupport</code> framework, and the open source <a href="https://github.com/apple/swift-syntax" target="_blank">swift-syntax</a> library as a dependency, this way we can setup a new macro target.</p><p>The <code>Examples</code> target is literally just a sample target to try out the macros, the <code>MyMacros</code> target will contain our macro definitions. The actual macro implementations will live in a separate macro target called <code>MyMacroPlugins</code>. Of course we‚Äôre going to validate the macros, unit tests are going to be placed inside the <code>MyMacrosTests</code> target. ‚úÖ</p><pre><code class="language-swift">// swift-tools-version: 5.9
import CompilerPluginSupport
import PackageDescription

let package = Package(
    name: "macro-examples",
    platforms: [
        .macOS(.v12),
    ],
    products: [
        .executable(
            name: "Examples",
            targets: ["Examples"]
        ),
        .library(
            name: "MyMacros",
            targets: ["MyMacros"]
        ),
    ],
    dependencies: [
        .package(
            url: "https://github.com/apple/swift-syntax",
            branch: "main"
        ),
    ],
    targets: [
        .macro(
            name: "MyMacrosPlugin",
            dependencies: [
                .product(
                  name: "SwiftSyntax",
                  package: "swift-syntax"
                ),
                .product(
                  name: "SwiftSyntaxMacros",
                  package: "swift-syntax"
                ),
                .product(
                  name: "SwiftOperators",
                  package: "swift-syntax"
                ),
                .product(
                  name: "SwiftParser",
                  package: "swift-syntax"
                ),
                .product(
                  name: "SwiftParserDiagnostics",
                  package: "swift-syntax"
                ),
                .product(
                  name: "SwiftCompilerPlugin",
                  package: "swift-syntax"
                ),
            ]
        ),
        .target(
            name: "MyMacros",
            dependencies: [
                "MyMacrosPlugin"
            ]
        ),
        .executableTarget(
            name: "Examples",
            dependencies: [
                "MyMacros"
            ]
        ),
        .testTarget(
            name: "MyMacrosTests",
            dependencies: [
                "MyMacrosPlugin"
            ]
        )
    ]
)
</code></pre><p>We‚Äôre going to create an simple <code>@Init</code> macro, which can generate a public initializer for various objects based on the member properties. Feel free to place this code into the <code>main.swift</code> file under the <code>Examples</code> target.</p><pre><code class="language-swift">import MyMacros
import Foundation

@Init
public struct Something: Codable {
    let foo: String
    let bar: Int
    let hello: Bool?
}

</code></pre><p>There is a protocol for this purpose called <code>MemberMacro</code>, which we have to implement in order to be able to access and extend the Swift syntax tree. Place the following contents into the <code>InitMacro.swift</code> file.</p><pre><code class="language-swift">import SwiftSyntax
import SwiftSyntaxMacros

public struct InitMacro: MemberMacro {

    public static func expansion&lt;D, C&gt;(
        of node: AttributeSyntax,
        providingMembersOf decl: D,
        in context: C
    ) throws -&gt; [SwiftSyntax.DeclSyntax]
    where D: DeclGroupSyntax, C: MacroExpansionContext {

        let members = decl.memberBlock.members
        var props: [(name: String, type: String)] = []
        for member in members {
            guard
                let v = member.decl.as(VariableDeclSyntax.self),
                let b = v.bindings.first,
                let i = b.pattern.as(IdentifierPatternSyntax.self),
                let t = b.typeAnnotation?.type
            else {
                continue
            }
            let n = i.identifier.text
            let tv = t.description
            props.append((name: n, type: tv))
        }

        let parameters = props
            .map { "\($0.name): \($0.type)"}
            .joined(separator: ",\n")

        let assignments = props
            .map { "self.\($0.name) = \($0.name)"}
            .joined(separator: "\n")

        return [
            """
            public init(
                \(raw: parameters)
            ) {
                \(raw: assignments)
            }
            """
        ]
    }
}
</code></pre><p>As you can see we ask the declaration for the member properties and iterate through each member. If a member has a <code>VariableDeclSyntax</code> it means it is a variable. We try to fetch the identifier using the <code>IdentifierPatternSyntax</code> and the type through the typeAnnotation property of the <code>bindings</code>. Don‚Äôt worry if you are not familiar with the swift-syntax library, you can easily print out (e.g. <code>po decl</code>) the object graph including the type names if you put a breakpoint into the macro function implementation and run the unit tests using Xcode. <code>po</code> actually works in Xcode 15. üòç</p><p>All right, we have the macro, but we still have to list it inside the plugin target using a special <code>CompilerPlugin</code> protocol.</p><pre><code class="language-swift">#if canImport(SwiftCompilerPlugin)
import SwiftCompilerPlugin
import SwiftSyntaxMacros

@main
struct MyMacrosPlugin: CompilerPlugin {

    let providingMacros: [Macro.Type] = [
        InitMacro.self,
    ]
}
#endif
</code></pre><p>Now the macro plugin target is ready, we just have to define the macro implementation inside the <code>MyMacros</code> target using <code>#externalMacro</code>, and reference the target module & macro type. Our macro will be an <code>@attached(member)</code> macro which is going to implement the <code>init</code> method.</p><pre><code class="language-swift">import Foundation

@attached(member, names: named(init))
public macro Init() = #externalMacro(
    module: "MyMacrosPlugin",
    type: "InitMacro"
)
</code></pre><p>You can learn more about the available macro atttributes from the <a href="https://developer.apple.com/search/?q=swift%20macro&type=Videos" target="_blank">WWDC23 session videos</a> or you can read the <a href="https://gist.github.com/DougGregor/4f3ba5f4eadac474ae62eae836328b71" target="_blank">vision</a> for Swift macros document and <a href="https://www.swift.org/swift-evolution/#?search=macro" target="_blank">correspoinding proposals</a> on the Swift Evolution Dashboard.</p><p>The only thing remains is the unit test for the Swift macro. It‚Äôs relatively easy to write tests for macro declarations, we can simply compare the source with the generated code block.</p><pre><code class="language-swift">import XCTest
import SwiftSyntax
import SwiftSyntaxBuilder
import SwiftSyntaxMacros
import MyMacrosPlugin

final class MyMacrosTests: XCTestCase {

    let testMacros: [String: Macro.Type] = [
        "Init": InitMacro.self,
    ]

    func testApiObjects() throws {

        let sf: SourceFileSyntax = """
        @Init
        public struct Something: Codable {
            let foo: String
            let bar: Int
            let hello: Bool?
        }
        """

        let expectation = """

        public struct Something: Codable {
            let foo: String
            let bar: Int
            let hello: Bool?
            public init(
                foo: String,
            bar: Int,
            hello: Bool?
            ) {
                self.foo = foo
            self.bar = bar
            self.hello = hello
            }
        }
        """

        let context = BasicMacroExpansionContext(
            sourceFiles: [
                sf: .init(
                    moduleName: "TestModule",
                    fullFilePath: "test.swift"
                )
            ]
        )

        let transformed = sf.expand(macros: testMacros, in: context)
        XCTAssertEqual(transformed.formatted().description, expectation)
    }
}

</code></pre><p>The output can be <code>formatted</code> based on your configuration, but since this is a beginner‚Äôs guide tutorial we‚Äôre not going into the details right now. Macros are a powerful new feature in Swift 5.9. We‚Äôre going to play & experiment with them a lot more, that‚Äôs for sure. I hope you get the basic idea how to setup a macro project based on this quick tutorial. üôè</p>
                    </section>
                    
                    
                </article>
            </div>
            <div>
                <aside>
                <span class="featured">featured</span>
        
                <div class="author-list">
                        <a href="http://localhost:3000/blog/authors/tibor-bodecs/">
                        <img class="medium rounded" src="/assets/blog/authors/tibor-bodecs/tibor-bodecs.jpeg" alt="Tibor B√∂decs">
                        </a>
                </div>
                <div class="tag-list">
                        <a href="http://localhost:3000/blog/tags/swift/"><small>Swift</small></a>
                </div>
                
                <h4>On this page</h4>
                <ul>
                    <li class="first-level">
                        <a href="#getting-started">Getting started</a>
                        <ul>
                        </ul>
                    </li>
                </ul>
                </aside>
            </div>
        </div>
        </div>
        
        <section class="primary">
            <div class="wrapper">
                <header>
                <h2>Related posts</h2>
                </header>
                <div class="grid grid-221">
                        <div class="card post">
                            <div class="author-list">
                            </div>
                        
                            <div class="meta">
                                <time datetime="2023.07.06. 16:15">2023.07.06. 16:15</time>
                                
                            </div>
                            
                            <h3><a href="http://localhost:3000/blog/posts/how-to-write-openapi-specs-using-swift-and-openapi-kit/">How to write OpenAPI specs using Swift and OpenAPIKit?</a></h3>
                            <p>In this tutorial I&#39;ll show you how to build OpenAPI 3.0+ specifications efficiently using Swift &amp; OpenAPIKit.</p>
                            
                            
                            <div class="tag-list">
                            </div>
                        </div>
                <div class="card post">
                            <div class="author-list">
                            </div>
                        
                            <div class="meta">
                                <time datetime="2023.05.18. 17:36">2023.05.18. 17:36</time>
                                
                            </div>
                            
                            <h3><a href="http://localhost:3000/blog/posts/push-notifications-with-swift-server-side/">Sending push notifications using server side Swift in 2023</a></h3>
                            <p>Learn how to send push notifications with Swift on the server side using the Google FCM API and the APN Swift library.</p>
                            
                            
                            <div class="tag-list">
                            </div>
                        </div>
                <div class="card post">
                            <div class="author-list">
                            </div>
                        
                            <div class="meta">
                                <time datetime="2023.04.24. 18:32">2023.04.24. 18:32</time>
                                
                            </div>
                            
                            <h3><a href="http://localhost:3000/blog/posts/static-site-generation-with-the-power-of-swift-and-toucan/">Static site geneneration with the power of Swift and Toucan</a></h3>
                            <p>Toucan is a lightweight static site generator written in Swift. This article will guide you through the process of creating your own website using it.</p>
                            
                            
                            <div class="tag-list">
                            </div>
                        </div>
                </div>
            </div>
        </section>
        
        <section class="book">
          <div class="wrapper">
              <header>
                  <h2>Swift on the server</h2>
                  <p>We specialize on server side Swift development. We are so dedicated and enthusiastic that we even wrote a book on the topic.</p>
              </header>
              <div class="grid grid-211">
                  <picture>
                    <img alt="Practical Server Side Swift Cover" src="http://localhost:3000/images/defaults/PSSScover.png"/>
                  </picture>
                  
                  <div class="info">
                    <h3>Practical Server-Side Swift</h3>
                    <p>Swift on the server is an amazing new opportunity to build fast, safe and scalable backend apps. Write your very first web-based application by using your favorite programming language. Learn how to build a modular blog engine using the latest version of the Vapor 4 framework. This book will help you to design and create modern APIs that'll allow you to share code between the server side and iOS. Start becoming a full-stack Swift developer.</p>
                    <p><a href="#">Download sample</a></p>
                    <p><a class="button" href="https://theswiftdev.gumroad.com/l/practical-server-side-swift" target="_blank">Available on Gumroad</a></p>
                  </div>
              </div>
              
              
            
          </div>
        </section>
        
    </main>
    
    <div id="footer-container">
        <footer class="wrapper">
            <div class="grid grid-211">
                <div>
                    <picture>
                        <source
                            srcset="http://localhost:3000/images/logos/logo~dark.png"
                            media="(prefers-color-scheme: dark)"
                            >
                        <img
                            src="http://localhost:3000/images/logos/logo.png"
                            alt="Logo of Binary Birds"
                            title="Binary Birds"
                            >
                    </picture>
                    <h2>Binary Birds</h2>
                    <p>Swift application development and consulting.<br>Secure, efficient, scalable solutions.</p>
                </div>
                <div class="links">
                    <div class="external">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                        </svg>
                    </div>
                    <div class="contact">
                        <h3>Contact</h3>
                        <p>
                        Binary Birds Kft.<br>
                        <a href="mailto:info@binarybirds.com">
                            info@binarybirds.com
                        </a>
                        </p>
                    </div>
                </div>
            </div>
                    
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/development">Development</a></li>
                    <li><a href="/consulting">Consulting</a></li>
                    <li><a href="/blog">Blog</a></li>
                </ul>
            </nav>
    
            <div id="copyright">Binary Birds ¬© 2022-2024 &middot; All Rights Reserved</div>
    
        </footer>
    </div>

    
    
    <script src="/js/favicon.js"></script>
</body>
</html>
